# Back end

This page shall provide more in-depth information on the structure of the back end and it's most important files.

## Structure

The back end is structured in a way, that distinguishes between a local development environment and a production environment.
Therefore some files such as the Dockerfile (see [**Installation**](/dashboard-docs/02_Installation)) are available twice. Depending on the environment, the respective files should either be used or are used automatically.
Files marked with the word **base** such as ``config/settings/base.py`` - as the name suggests - serve as a base for both,
the local and the production environment. 

```console
.
├── .envs
├── compose
│   ├── local
│   └── production
├── config
│   └── settings
├── dashboard
│   ├── contrib
│   ├── patients
│   ├── static
│   ├── templates
│   ├── users
│   ├── utils
│   └── webpack_bundle
├── docs
│   ├── _build
│   └── _source
├── locale
├── requirements

```

!!! info "Getting started"
    
    The most important folders, to get started with the back end are the following:

    - **config** : The settings for the project are to be found in the config folder.
    - **dashboard/patients** : This is the main app of the back end. It inherits the model definitions as well as the API's and the views.
    - **dashboard/static** : Just for information purposes: The static (HTML, CSS, JS..) files that are generated by the front end, will be transfered into this folder.
    - **dashboard/templates** : Just for information purposes: Here lives the ``home.html`` which is the root of the app that is being served in the browser. 
    - **requirements** : All the requirements (dependencies) that are needed for development and/or production purposes.

In the following, each of the different sections of the back end will be explained in more detail.

??? info "env files"
    
    Environment files are mainly used to store sensitive data such as passwords or secret keys that may cause vulnerabilities if exposed in the code.
    In local environments some things may be hardcoded, when they are depending on environment variables in production. This is an intended behaviour and should not be changed.
    See the ``config`` section and information about the settings. Most of the settings that require environment variables are defined there.

    ```console

        .envs
        ├── .local
        │   ├── .django
        │   └── .postgres
        └── .production
            ├── .django
            └── .postgres
    ```


??? info "compose"

    Except for the ``.yml`` files, all of the docker configuration is to be found in this directory. As usual, the configurations are separated by environments.

    ```console

    .
    ├── local
    │   ├── django
    │   │   ├── Dockerfile
    │   │   └── start
    │   └── docs
    │       └── Dockerfile
    └── production
        ├── django
        │   ├── Dockerfile
        │   ├── entrypoint
        │   └── start
        ├── postgres
        │   ├── Dockerfile
        │   └── maintenance
        │       ├── _sourced
        │       ├── backup
        │       ├── backups
        │       └── restore
        └── traefik
            ├── Dockerfile
            └── traefik.yml

    ```

???+ info "config"

    The main settings of the software are to be found in the config folder. Whats normally the ``settings.py`` file, lives in the ``settings`` folder and is separated by environment.
    Because there are settings, that local and production environments have in common, there is also a ``base.py``, that serves as the base. In a local environment, the settings of both the ``base.py`` and the ``local.py`` will be considered.


    ```console

    ├── __init__.py
    ├── api_router.py
    ├── asgi.py
    ├── middleware.py
    ├── settings
    │   ├── __init__.py
    │   ├── base.py
    │   ├── local.py
    │   ├── production.py
    │   └── test.py
    ├── urls.py
    └── wsgi.py

    ```

??? info "dashboard"

    ```console
    .
    ├── contrib
    │   └── sites
    │       └── migrations
    ├── patients
    │   ├── api
    │   └── migrations
    ├── static
    │   ├── css
    │   ├── fonts
    │   ├── images
    │   │   └── favicons
    │   ├── js
    │   ├── sass
    │   └── vue
    │       ├── css
    │       ├── fonts
    │       ├── img
    │       └── js
    ├── templates
    │   ├── account
    │   ├── pages
    │   ├── users
    │   └── webpack_bundle
    ├── users
    │   ├── api
    │   ├── migrations
    │   └── tests
    ├── utils
    └── webpack_bundle
        └── templatetags

    ```

??? info "requirements"

    The requirements follow the logic that was presented in the settings. ``base.txt`` is serving as a base for both local and production environments. Depending on the environment, the respective requirements will be installed additionally.
    The ``base.txt`` should only include what's needed in both environments. 

    ```console
    .
    ├── base.txt
    ├── local.txt
    └── production.txt

    ```

### Local

This section goes more into detail on how to develop the backend locally. While the installation is covered on the installation page, this 
section also provides details on which settings one might configure for their specific environment.

#### Local development

As explained on the installation page, there are two different ``docker-compose`` files for each of the environment. For local development, the docker container is built
and started by executing the following two commands in the root directory of the project.

```console

docker-compose local.yml -f build

```

This first command builds the docker container and installs all of the necessary requirements for the back end. Because we are building the
container for the local environment here, the requirements ``base.txt`` and ``local.txt`` will be installed. 

The following command starts the docker container.

```console

docker-compose local.yml -f up

```

Together with **django** some other processes, including **redis** (cache) and **postgres** (database) will be started.

After starting the docker container, the console output would look something like the following:

```console

redis       | 1:M 19 May 2021 13:09:00.119 * Ready to accept connections
postgres    | 2021-05-19 13:09:01.875 UTC [26] LOG:  database system was shut down at 2021-05-11 19:27:08 UTC
postgres    | 2021-05-19 13:09:01.895 UTC [1] LOG:  database system is ready to accept connections
django      | PostgreSQL is available
django      | Operations to perform:
django      |   Apply all migrations: admin, auth, authtoken, background_task, contenttypes, patients, sessions, sites, users
django      | Running migrations:
django      |   No migrations to apply.
django      | INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)

```

The last line of the output shows the URL of the application. However, to fully be able to develop locally, pay attention to
the [**Front End**](/05_frontend) page. 

After the docker container is up and running, additional commands (like ``makemigrations`` e.g.), inside the container can be execuded using the ``exec``
command:

```console

docker-compose -f local.yml exec django python manage.py makemigrations

```

### Production

The most important difference between the local and the production environment are the **environment variables**.
Not only, but mostly sensitive information is stored in environment variables and will not be exported from a local environment
to a production environment. Therefore these environment variables have to be set in the production environment.
It is suggested not to hardcode values for such variables into the code for production, but to really set and use environment variables.

#### Configuring the environment

!!! info "environment variables"

    The environment files can be found in the ``.envs`` directory like shown before.
    The most important thing for us here now is ``env_file`` section enlisting ``./.envs/.local/.postgres``. Generally, the stack's behavior is governed by a number of environment variables (`env(s)`, for short) residing in ``envs/``.
    
    ```console
    # PostgreSQL
    # ------------------------------------------------------------------------------
    POSTGRES_HOST=postgres
    POSTGRES_DB=<your project slug>
    POSTGRES_USER=<your postgres user>
    POSTGRES_PASSWORD=<your password>
    ```

...